name: Build and Publish Kernel

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:
    inputs:
      publish:
        description: "Publish to HF Hub after build"
        required: false
        default: false
        type: boolean

jobs:
  # PR builds - just validate the kernel builds
  build-pr:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Free disk space and add swap
        run: |
          echo "Before cleanup"
          df -h
          free -h
          # Remove large pre-installed packages
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf /usr/local/.ghcup
          sudo rm -rf /usr/local/share/powershell
          sudo rm -rf /usr/local/share/chromium
          sudo rm -rf /usr/local/lib/node_modules
          sudo rm -rf /usr/share/swift
          sudo rm -rf /usr/share/miniconda
          sudo rm -rf /usr/local/graalvm
          sudo rm -rf /usr/local/julia*
          # Clean apt cache
          sudo apt-get clean
          # Remove docker images
          sudo docker image prune --all --force
          sudo docker system prune --all --force --volumes
          # Add 20GB swap for memory-intensive builds (may fail in containers)
          sudo fallocate -l 20G /swapfile || true
          sudo chmod 600 /swapfile || true
          sudo mkswap /swapfile || true
          sudo swapon /swapfile || true
          echo "After cleanup"
          df -h
          free -h

      - uses: actions/checkout@v4

      - name: Build kernel (CI)
        uses: huggingface/publish-to-the-kernel-hub-action@main
        with:
          kernel-path: "."
          build-target: ci
          nix-command: build
          nix-max-jobs: "1"
          nix-cores: "2"
          sandbox-mode: "false"
          upload-artifact: "false"
          extra-nix-conf: |
            min-free = 10000000000
            max-free = 20000000000

  # Release builds - build and upload to HF Hub
  build-release:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Free disk space and add swap
        run: |
          echo "Before cleanup"
          df -h
          free -h
          # Remove large pre-installed packages
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf /usr/local/.ghcup
          sudo rm -rf /usr/local/share/powershell
          sudo rm -rf /usr/local/share/chromium
          sudo rm -rf /usr/local/lib/node_modules
          sudo rm -rf /usr/share/swift
          sudo rm -rf /usr/share/miniconda
          sudo rm -rf /usr/local/graalvm
          sudo rm -rf /usr/local/julia*
          # Clean apt cache
          sudo apt-get clean
          # Remove docker images
          sudo docker image prune --all --force
          sudo docker system prune --all --force --volumes
          # Add 20GB swap for memory-intensive builds (may fail in containers)
          sudo fallocate -l 20G /swapfile || true
          sudo chmod 600 /swapfile || true
          sudo mkswap /swapfile || true
          sudo swapon /swapfile || true
          echo "After cleanup"
          df -h
          free -h

      - uses: actions/checkout@v4

      - name: Build and upload kernel
        uses: huggingface/publish-to-the-kernel-hub-action@main
        with:
          kernel-path: "."
          build-target: build-and-upload
          nix-command: run
          nix-max-jobs: "1"
          nix-cores: "2"
          sandbox-mode: fallback
          upload-artifact: "false"
          hf-repo: drbh/relu
          extra-nix-conf: |
            min-free = 10000000000
            max-free = 20000000000
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}

  # Manual dispatch - allows testing either mode
  build-manual:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Free disk space and add swap
        run: |
          echo "Before cleanup"
          df -h
          free -h
          # Remove large pre-installed packages
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf /usr/local/.ghcup
          sudo rm -rf /usr/local/share/powershell
          sudo rm -rf /usr/local/share/chromium
          sudo rm -rf /usr/local/lib/node_modules
          sudo rm -rf /usr/share/swift
          sudo rm -rf /usr/share/miniconda
          sudo rm -rf /usr/local/graalvm
          sudo rm -rf /usr/local/julia*
          # Clean apt cache
          sudo apt-get clean
          # Remove docker images
          sudo docker image prune --all --force
          sudo docker system prune --all --force --volumes
          # Add 20GB swap for memory-intensive builds (may fail in containers)
          sudo fallocate -l 20G /swapfile || true
          sudo chmod 600 /swapfile || true
          sudo mkswap /swapfile || true
          sudo swapon /swapfile || true
          echo "After cleanup"
          df -h
          free -h

      - uses: actions/checkout@v4

      - name: Build kernel (CI mode)
        if: inputs.publish != true
        uses: huggingface/publish-to-the-kernel-hub-action@main
        with:
          kernel-path: "."
          build-target: ci
          nix-command: build
          nix-max-jobs: "1"
          nix-cores: "2"
          sandbox-mode: fallback
          upload-artifact: "false"
          extra-nix-conf: |
            min-free = 10000000000
            max-free = 20000000000

      - name: Build and upload kernel (Release mode)
        if: inputs.publish == true
        uses: huggingface/publish-to-the-kernel-hub-action@main
        with:
          kernel-path: "."
          build-target: build-and-upload
          nix-command: run
          nix-max-jobs: "1"
          nix-cores: "2"
          sandbox-mode: fallback
          upload-artifact: "false"
          hf-repo: drbh/relu
          extra-nix-conf: |
            min-free = 10000000000
            max-free = 20000000000
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
